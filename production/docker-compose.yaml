# version: '3.8'

services:
  open-webui2:
    image: ghcr.io/open-webui/open-webui:Latest
    container_name: open-webui2
    # Removed external portâ€”only Nginx accesses it
      gpus:
        - driver: nvidia
          count: all
          capabilities: ["gpu"]

    volumes:
      - ollama:/root/.ollama
      - open-webui:/app/backend/data
    restart: always
    networks:
      - internal

  tailscale-sidecar:
    image: tailscale/tailscale:latest
    container_name: tailscale-sidecar
    hostname: jarvis
    privileged: true
    environment:
      TS_AUTHKEY: ${TS_AUTHKEY}
      TS_HOSTNAME: jarvis  
      TS_ACCEPT_DNS: true
    volumes:
      - tailscale-sidecar-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    restart: always
    network_mode: host

  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: always
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - open-webui2
    networks:
      - internal
    ports:
      - "127.0.0.1:8080:80"

networks:
  internal:
    driver: bridge

volumes:
  ollama:
    driver: local
  open-webui:
    driver: local
  tailscale-sidecar-state:
    driver: local

